name: cardio_pulmonary_bstar

on:
  workflow_dispatch:

env:
  IMAGE_NAME: litgt_cardio_pulmonary_bstar
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    if: github.actor == 'ahsanjav' || github.actor == 'pdaude'
    runs-on: [self-hosted]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Clean workspace
        run: rm -rf "$GITHUB_WORKSPACE"/* "$GITHUB_WORKSPACE"/.[!.]* 2>/dev/null || true

      - name: Checkout cardiopulmonary_bstar branch
        run: |
          git clone --branch cardiopulmonary_bstar --single-branch https://github.com/${{ github.repository }}.git .


      - name: Get current date (YYYYMMDD)
        id: get_date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Set DATE environment variable
        run: echo "DATE=${{ steps.get_date.outputs.date }}" >> $GITHUB_ENV

      - name: Set lowercase owner name
        run: echo "OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Check GPU
        run: |
          nvidia-smi || true
          nvcc --version || true

      - name: Build Docker image dev (latest)
        run: |
          docker build --target gadgetron_cudabuild \
            -t ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_dev:latest \
            -t ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_dev:${{ env.DATE }} .

      - name: Push Docker image dev (latest)
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_dev:latest
          docker push ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_dev:${{ env.DATE }}

      - name: Build Docker image rt (latest)
        run: |
          docker build --target gadgetron_rt_cuda \
            -t ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_rt:latest \
            -t ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_rt:${{ env.DATE }} .

      - name: Push Docker image rt (latest)
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_rt:latest
          docker push ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}_rt:${{ env.DATE }}
